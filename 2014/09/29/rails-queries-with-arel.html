<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1'/>
  <title>Jocellyn's Blog  - Rails queries with Arel</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link href="//cdnjs.cloudflare.com/ajax/libs/c3/0.1.29/c3.css" rel="stylesheet" type="text/css">

  <link href='http://fonts.googleapis.com/css?family=Sue+Ellen+Francisco|Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="../../../stylesheets/main.css" rel="stylesheet" />
  <meta name="google-site-verification" content="rnwDRfWLERH4z0UoMfWumemvsRSmRIQTz3dd15flK4k" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
</head>
<body>


<div id="main" role="main" class="container">
  <div class="row">
    <a href="/"><h1 class="title"> Jocellyn's Blog</h1></a>

    <div class="col-md-3 image menu">
      <a href="/">
        <img src="../../../images/2.jpeg" class="logo" alt="" />
      </a>
      <h2>Recent Articles</h2>
      <ol>
          <li><a href="/2018/02/21/how-much-for-my-next-uber.html">How much for my next Uber? Light intro to machine learning</a> </li>
          <li><a href="/2018/01/25/simple-game-development-with-pixi.html">The simplest game development with Pixi.js</a> </li>
          <li><a href="/2018/01/25/how-did-i-lost-fear-from-recruiters.html">How did I lose fear from recruiters</a> </li>
          <li><a href="/2017/10/30/where-to-find-remote-job.html">Where to find remote job</a> </li>
          <li><a href="/2017/04/16/why-ruby-is-slow.html">Why Ruby is slow?</a> </li>
          <li><a href="/2016/10/18/why-am-i-leaving-msd.html">Why am I leaving MSD</a> </li>
          <li><a href="/2015/11/13/d3-simple-example.html">D3 simple visualization (Visu homework V)</a> </li>
          <li><a href="/2015/10/29/interesting-visualization.html">Interesting visualization (Visu homework IV.)</a> </li>
          <li><a href="/2015/10/21/what-is-wrong-with-that-graph.html">What is wrong with that graph? (Visu homework III.)</a> </li>
          <li><a href="/2015/10/19/cleaning-data-for-visualization.html">Cleaning data for visualization (Visu homework II.)</a> </li>
      </ol>

      <h2>Tags</h2>
      <ol>
          <li><a href="/tags/machine-learning.html">machine learning (1)</a></li>
          <li><a href="/tags/programming.html">programming (21)</a></li>
          <li><a href="/tags/game-development.html">game development (1)</a></li>
          <li><a href="/tags/javascript.html">javascript (4)</a></li>
          <li><a href="/tags/career.html">career (3)</a></li>
          <li><a href="/tags/ruby.html">ruby (14)</a></li>
          <li><a href="/tags/performance.html">performance (1)</a></li>
          <li><a href="/tags/visualization.html">visualization (6)</a></li>
          <li><a href="/tags/haskell.html">haskell (2)</a></li>
          <li><a href="/tags/rails.html">rails (9)</a></li>
          <li><a href="/tags/mongodb.html">mongodb (2)</a></li>
          <li><a href="/tags/sociology.html">sociology (6)</a></li>
          <li><a href="/tags/self-improvement.html">self-improvement (11)</a></li>
          <li><a href="/tags/eu.html">EU (3)</a></li>
          <li><a href="/tags/education.html">education (3)</a></li>
          <li><a href="/tags/love.html">love (1)</a></li>
      </ol>

      <h2>By Year</h2>
      <ol>
        <li><a href="/2018.html">2018 (3)</a></li>
        <li><a href="/2017.html">2017 (2)</a></li>
        <li><a href="/2016.html">2016 (1)</a></li>
        <li><a href="/2015.html">2015 (6)</a></li>
        <li><a href="/2014.html">2014 (15)</a></li>
        <li><a href="/2013.html">2013 (7)</a></li>
        <li><a href="/2012.html">2012 (8)</a></li>
    </ol>


    </div>
    <div class="col-md-7 articles">
        <div class="single-post">

    <h1>Rails queries with Arel</h1>

    <p>This article is focusing on basics of building up queries in Rails. What is a query? Well, we can imagine that as a question
to our database which gets us some subset of what is stored there. When we do <code>Model.first</code> or <code>Model.all</code> we are building up a simple queries.
But what if you want something more complex and possible something involving more than one model? </p>

<p>Well, there are several ways how to get such results from your database.
First and probably most well known is to combine Active Record methods with pure SQL in strings for a specific and difficult parts. 
I will soon discuss why that is not always ideal solution and I will present the alternative way using Arel library.
Oh and of course there is also the &ldquo;beginners&rdquo; way how to get desirable data - you can use only Ruby to filter what has been returned by simple queries like <code>.all</code>.
This is really slow and ineffective as will be also described.</p>

<p>Lets say we have two tables <code>tasks</code> and <code>solutions</code> and we want to join them, group them based on their relationship
and then select task title and the count of that task belonging solutions. 
We want to end up with a simple table like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>"Abandoned Island",1
"I am so grateful",8
"Describe your relationship",11
"Your fear",17
"Write something about you!",1
"My new professions",8
"What makes you smile",6
</code></pre></div>
<p>A complete beginner, like me few months ago, would say: &ldquo;hey, that&rsquo;s easy. We will get all tasks, all solutions and then we will somehow 
get what we need&rdquo;. This could look like:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="no">Task</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
   <span class="n">all_solutions</span> <span class="o">=</span> <span class="no">Solution</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">task_id: </span><span class="n">task</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
   <span class="n">result</span><span class="p">[</span><span class="ss">:task</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_solutions</span><span class="p">.</span><span class="nf">count</span>
<span class="k">end</span>
</code></pre></div>
<p>Or even worse, someone could decide to use <code>filter</code> instead of <code>where</code>. It is really not hard to see that this is the completely wrong way. We are pulling <strong>all</strong> the tasks into memory and then we are looking
at each task and pulling all his solutions only to in the end we would count the desirable count and produce a final Hash. For this purpose
we have the database abstraction - <code>Active Record</code> - to do the hard stuff. We should keep Ruby methods away from database queries as much as it is possible.</p>

<p>So what are these database methods which we can use? Of course there is <code>where</code>, but that is usually not enough. Now it is time for the 
promised SQL in the string. To compose the previous example we could do something like this:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">Task</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:solutions</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s2">"tasks.id"</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s2">"tasks.title, count(solutions.id)"</span><span class="p">)</span>
</code></pre></div>
<p>The part in the string <code>&quot;tasks.title, count(solutions.id)&quot;</code> is the <strong>pure SQL</strong> which doesn&rsquo;t have anything in common with the rest of the code.
It is <strong>embedding a different language</strong> into Ruby just for this little part.
Well, we helped ourselves significantly in compared to the <code>each</code> variant. But this is still far from perfect.</p>

<p>Why?</p>

<ul>
<li>We need to know the syntax of our database language, in this case SQL. If we switched database, we would have to rewrite this part.</li>
<li>It is not very object oriented way how to write code, you can not e.g. chain methods together</li>
<li>You do not have any syntax check inside of the string</li>
</ul>

<p>And here come the third option - <strong>Arel</strong>. Arel is a library which helps us to construct queries. It is used by <code>Active Record</code> to construct
queries, so everytime you do <code>where</code> or <code>limit</code> or <code>first</code>, you essentially use Arel. 
But there is more to that - we can exchange Arel methods for that ugly SQL strings we saw before. </p>

<p>The previous example from previous could be written as:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">Task</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:solutions</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s2">"tasks.id"</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="no">Task</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="s2">"title"</span><span class="p">],</span> <span class="no">Solution</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="s2">"id"</span><span class="p">].</span><span class="nf">count</span><span class="p">)</span>
</code></pre></div>
<p>Every Rails model has a method called <code>arel_table</code> which allows us to get information about a table or a column on that belonging table by using Hash syntax. 
We can see what is returned by <code>arel_table</code> in this example:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">arel_table</span>

<span class="o">=&gt;</span> <span class="c1">#&lt;Arel::Table:0x007ff9f39ab718</span>
 <span class="vi">@aliases</span><span class="o">=</span><span class="p">[],</span>
 <span class="vi">@columns</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span>
 <span class="vi">@engine</span><span class="o">=</span>
  <span class="no">User</span><span class="p">(</span><span class="ss">id: </span><span class="n">integer</span><span class="p">,</span> <span class="ss">email: </span><span class="n">string</span><span class="p">,</span> <span class="ss">encrypted_password: </span><span class="n">string</span><span class="p">,</span> <span class="ss">reset_password_token: </span><span class="n">string</span><span class="p">,</span> <span class="ss">reset_password_sent_at: </span><span class="n">datetime</span><span class="p">,</span> <span class="ss">remember_created_at: </span><span class="n">datetime</span><span class="p">,</span> <span class="ss">sign_in_count: </span><span class="n">integer</span><span class="p">,</span> <span class="ss">current_sign_in_at: </span><span class="n">datetime</span><span class="p">,</span> <span class="ss">last_sign_in_at: </span><span class="n">datetime</span><span class="p">,</span> <span class="ss">current_sign_in_ip: </span><span class="n">string</span><span class="p">,</span> <span class="ss">last_sign_in_ip: </span><span class="n">string</span><span class="p">,</span> <span class="ss">created_at: </span><span class="n">datetime</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="n">datetime</span><span class="p">,</span> <span class="ss">admin: </span><span class="n">boolean</span><span class="p">,</span> <span class="ss">authentication_token: </span><span class="n">string</span><span class="p">,</span> <span class="ss">uid: </span><span class="n">string</span><span class="p">,</span> <span class="ss">provider: </span><span class="n">string</span><span class="p">),</span>
 <span class="vi">@name</span><span class="o">=</span><span class="s2">"users"</span><span class="p">,</span>
 <span class="vi">@primary_key</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span>
 <span class="vi">@table_alias</span><span class="o">=</span><span class="kp">nil</span><span class="o">&gt;</span>
</code></pre></div>
<p>This is used in building up queries. Arel is in the end writing the SQL queries for us.To find out which SQL is produced we can write</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="p">.</span><span class="nf">to_sql</span>
</code></pre></div>
<p>in the end of our query and immediately get the raw SQL. 
 Anyway, we can see that it is much more object oriented, we can chain queries, we can call methods as <code>count</code> on them, 
 we can reuse them better and store parts in variables..</p>

<p>Ok, so what else can we do with <code>arel_table</code> ? We can build predicates very easily, like:</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="no">Model</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="no">Model</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">not_eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="no">Model</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">in</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
  <span class="no">Model</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">not_in</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>
<p>There is another advantage of using Arel instead of row SQL. We do not have to use the hideous <em>question marks</em> to match arguments, check out this last example:</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="c1"># SQL question marks</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"title"</span> <span class="o">=</span> <span class="p">?</span> <span class="no">AND</span> <span class="n">is_active</span> <span class="o">=</span> <span class="sc">?"</span><span class="p">,</span> <span class="s2">"Love"</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>

  <span class="c1"># Arel!</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="no">Task</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[</span><span class="s2">"title"</span><span class="p">].</span><span class="nf">eq</span><span class="p">(</span><span class="s2">"Love"</span><span class="p">).</span><span class="nf">and</span><span class="p">(</span><span class="no">Task</span><span class="p">.</span><span class="nf">arel_table</span><span class="p">[:</span><span class="n">is_active</span><span class="p">].</span><span class="nf">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">))</span>
</code></pre></div>
<p>If you want to dive deeply into Arel, I recommend this <a href="http://www.confreaks.com/videos/3332-railsconf-advanced-arel-when-activerecord-just-isn-t-enough">video</a> and these articles <a href="http://jpospisil.com/2014/06/16/the-definitive-guide-to-arel-the-sql-manager-for-ruby.html">I</a> and <a href="http://pivotallabs.com/using-arel-to-build-complex-sql-expressions/">II</a>. </p>

    <hr class="space-maker">


    <div class="social-buttons-wrap">
      <div class="social-buttons">
        <div class="inner-buttons">
          <script type="text/javascript" src="http://www.reddit.com/static/button/button2.js"> </script>
          <br>
          <div class="g-plusone" data-size="tall"></div>
          <br>
          <a href="https://twitter.com/share" class="twitter-share-button" data-related="Jocinka" data-lang="en" data-size="medium" data-count="vertical"> Tweet </a>
          <br>
          <div class="fb-like" data-href="http://jocellyn.cz#{current_article.url}" data-layout="box_count" data-action="like" data-show-faces="true" data-share="true"> </div>
        </div>
      </div>
    </div>

    <div class="row well" id="journey">
        <a href="http://journeyapp.net/" target="_blank">
            <div class="col-md-8">
                <h3> Journey - Think. Write. Grow. </h3>
                <p> Self-improvement app which will help you to focus on your emotions, be positive and stay mindful. </p>
            </div>
            <div class="col-md-4">
                <img src="../../../images/journey.png" class="journey" alt="" />
            </div>
        </a>
    </div>

    <hr class="space-maker">
    <h1>Comments</h1>
    <div class="disqus">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'jocellyncz'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38390510-1', 'jocellyn.cz');
ga('send', 'pageview');

    </script>

    </div>
  </div>
</div>

<div class="invisible">
  <a href="https://plus.google.com/101530780379992796153?rel=author">Google</a>
</div>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38390510-1', 'jocellyn.cz');
ga('send', 'pageview');

</script>
<script type="text/javascript">
var _gauges = _gauges || [];
(function() {
 var t   = document.createElement('script');
 t.type  = 'text/javascript';
 t.async = true;
 t.id    = 'gauges-tracker';
 t.setAttribute('data-site-id', '5364b096eddd5b1500001191');
 t.src = '//secure.gaug.es/track.js';
 var s = document.getElementsByTagName('script')[0];
 s.parentNode.insertBefore(t, s);
 })();
</script>
</body>
</html>

    <script type="text/javascript">
(function() {
 var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
 po.src = 'https://apis.google.com/js/platform.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
 })();
    </script>
    <div id="fb-root"></div>
    <script type="text/javascript">
(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=301963046612249&version=v2.0";
 fjs.parentNode.insertBefore(js, fjs);
 }(document, 'script', 'facebook-jssdk'));</script>
    </script>
    <script type="text/javascript">
!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>
